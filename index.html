<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶å…‰åŠ©æ‰‹ v3.0 - äº‘ç«¯åŒæ­¥ç‰ˆ</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #4CAF50;
            --danger: #ff4757;
            --warning: #ffa502;
            --info: #00d2ff;
            --bg: #f5f7fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        /* ç»Ÿä¸€å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* ç™»å½•ç•Œé¢ */
        .login-container {
            width: 90%;
            max-width: 400px;
            padding: 40px;
            text-align: center;
        }

        .login-container h2 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 28px;
        }

        .login-container p {
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 16px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
            margin-left: 4px;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #edf2f7;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8fafc;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* ä¸»ç•Œé¢ */
        .main-container {
            display: none;
            width: 100%;
            height: 100vh;
            background: var(--bg);
            flex-direction: column;
        }

        .top-nav {
            background: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .nav-logo {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            background: #edf2f7;
            padding: 4px;
            border-radius: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .content-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* ä»ªè¡¨ç›˜ç½‘æ ¼ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* ä»»åŠ¡å¡ç‰‡ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
        }

        .category-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border-top: 5px solid var(--primary);
        }

        .task-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #ddd;
        }

        /* ä¼˜å…ˆçº§è‰²å— */
        .p-urgent-important { border-left-color: var(--danger); }
        .p-urgent { border-left-color: var(--warning); }
        .p-important { border-left-color: var(--primary); }
        .p-normal { border-left-color: #cbd5e0; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .hidden { display: none !important; }

        /* æç¤ºæ¡† */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 2000;
            display: none;
            animation: fadeInUp 0.3s;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .top-nav { flex-direction: column; gap: 12px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .category-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- ç™»å½•æ¨¡å— -->
    <div id="loginView" class="card login-container">
        <h2>â° æ—¶å…‰åŠ©æ‰‹</h2>
        <p>äº‘ç«¯åŒæ­¥ Â· å®ˆæŠ¤æ¯ä¸€ä»½è‡ªå¾‹</p>
        <div class="input-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>
        <div class="input-group">
            <label>å¯†ç </label>
            <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>
        <button class="btn btn-primary" id="loginBtn">è¿›å…¥æ—¶å…‰ç©ºé—´</button>
        <div id="authStatus" style="font-size: 12px; color: #999; margin-top: 15px;">æ­£åœ¨å‡†å¤‡äº‘ç«¯è¿æ¥...</div>
    </div>

    <!-- ä¸»ç•Œé¢æ¨¡å— -->
    <div id="mainView" class="main-container">
        <nav class="top-nav">
            <div class="nav-logo">â° æ—¶å…‰åŠ©æ‰‹ Cloud</div>
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="window.switchTab('tasks', this)">ä»»åŠ¡ç®¡ç†</button>
                <button class="tab-btn" onclick="window.switchTab('review', this)">æˆé•¿å›é¡¾</button>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="userDisplay" style="font-size: 13px; color: #666;"></span>
                <button id="logoutBtn" style="padding: 6px 12px; border:none; border-radius:6px; background:#ffe5e5; color:var(--danger); cursor:pointer;">é€€å‡º</button>
            </div>
        </nav>

        <div class="content-area">
            <!-- ä»»åŠ¡è§†å›¾ -->
            <div id="tab-tasks">
                <div class="dashboard-grid">
                    <div class="card" style="padding:20px;">
                        <h3 id="dateTitle">ä»Šå¤©</h3>
                        <div id="miniStats" style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div style="background:#f0f4ff; padding:15px; border-radius:12px; text-align:center;">
                                <div id="urgentCount" style="font-size:24px; font-weight:bold; color:var(--danger);">0</div>
                                <div style="font-size:12px; color:#666;">ç´§æ€¥å¾…åŠ</div>
                            </div>
                            <div style="background:#f0fff4; padding:15px; border-radius:12px; text-align:center;">
                                <div id="doneCount" style="font-size:24px; font-weight:bold; color:var(--success);">0</div>
                                <div style="font-size:12px; color:#666;">ä»Šæ—¥å®Œæˆ</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="padding:20px; background: linear-gradient(135deg, #f093fb, #f5576c); color:white;">
                        <h3 style="margin-bottom:10px;">ğŸ“ çµæ„Ÿéšç¬”</h3>
                        <textarea id="noteInput" placeholder="è®°å½•ä¸‹è¿™ä¸€åˆ»çš„æƒ³æ³•..." style="height:80px; background:rgba(255,255,255,0.2); border:none; color:white; resize: none;"></textarea>
                        <button class="btn" id="saveNoteBtn" style="margin-top:10px; background:white; color:#f5576c; padding:8px;">ç«‹å³ä¿å­˜</button>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>æˆ‘çš„ä»»åŠ¡åˆ†ç±»</h2>
                    <button class="btn btn-primary" style="width:auto; padding:8px 20px;" onclick="window.openModal('catModal')">+ æ–°å»ºåˆ†ç±»</button>
                </div>
                <div id="categoryGrid" class="category-grid"></div>
            </div>

            <!-- æˆé•¿å›é¡¾è§†å›¾ -->
            <div id="tab-review" class="hidden">
                <h2>æˆé•¿è½¨è¿¹</h2>
                <div id="historyList" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="catModal" class="modal-overlay">
        <div class="modal">
            <h3>æ–°å»ºä»»åŠ¡åˆ†ç±»</h3>
            <div class="input-group" style="margin-top:20px;">
                <input type="text" id="newCatName" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œã€å­¦ä¹ ã€å¥èº«">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" onclick="window.closeModal('catModal')" style="background:#eee;">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmCatBtn">åˆ›å»ºåˆ†ç±»</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal-overlay">
        <div class="modal">
            <h3>æ·»åŠ æ–°ä»»åŠ¡</h3>
            <div class="input-group" style="margin-top:15px;">
                <label>ä»»åŠ¡åç§°</label>
                <input type="text" id="newTaskTitle">
            </div>
            <div class="input-group">
                <label>ä¼˜å…ˆçº§</label>
                <select id="newTaskPriority">
                    <option value="p-normal">æ™®é€š</option>
                    <option value="p-important">é‡è¦</option>
                    <option value="p-urgent">ç´§æ€¥</option>
                    <option value="p-urgent-important">é‡è¦ä¸”ç´§æ€¥</option>
                </select>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" onclick="window.closeModal('taskModal')" style="background:#eee;">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmTaskBtn">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div id="toast">æç¤ºä¿¡æ¯</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase åˆå§‹åŒ–
        // æ³¨æ„ï¼šå¦‚æœä½ éƒ¨ç½²åˆ° GitHubï¼Œè¯·å°†ä¸‹è¡Œæ›¿æ¢ä¸ºä½ çœŸå®çš„ firebaseConfig å¯¹è±¡
        const firebaseConfig = {
  apiKey: "AIzaSyB-VTeLw0nrQOeP7T4JmT1h7qJY45V5GFM",
  authDomain: "timeassitant.firebaseapp.com",
  projectId: "timeassitant",
  storageBucket: "timeassitant.firebasestorage.app",
  messagingSenderId: "144323679667",
  appId: "1:144323679667:web:93e3e50447aeb6ca62e7c6",
  measurementId: "G-M1JCXB55RK"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'time-assistant-cloud';

        // çŠ¶æ€
        let user = null;
        let userData = null;
        let categories = [];
        let tasks = [];
        let activeCatId = null;

        // --- æ ¸å¿ƒè®¤è¯é€»è¾‘ ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error", error);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('authStatus').innerText = "âœ… äº‘ç«¯å·²å°±ç»ªï¼Œè¯·ç™»å½•ç©ºé—´";
            }
        });

        // --- ä¸šåŠ¡å‡½æ•° ---
        const handleAuth = async () => {
            if (!user) { showToast("æ­£åœ¨è¿æ¥äº‘ç«¯..."); return; }
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) { showToast("è¯·å®Œæ•´å¡«å†™"); return; }

            // å…¬å…±ç”¨æˆ·æ•°æ®è·¯å¾„
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', username);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                if (userSnap.data().password === password) {
                    completeLogin(username);
                } else {
                    showToast("å¯†ç é”™è¯¯");
                }
            } else {
                await setDoc(userRef, { username, password, uid: user.uid, createdAt: new Date().toISOString() });
                completeLogin(username);
                showToast("æ¬¢è¿å¼€å¯æ—¶å…‰æ—…ç¨‹ï¼");
            }
        };

        const completeLogin = (username) => {
            userData = { username };
            document.getElementById('userDisplay').innerText = username;
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('mainView').style.display = 'flex';
            startDataListeners();
        };

        const startDataListeners = () => {
            if (!user) return;
            const userPath = `artifacts/${appId}/users/${user.uid}`;
            
            // åˆ†ç±»ç›‘å¬
            onSnapshot(collection(db, userPath, 'categories'), (snap) => {
                categories = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories();
            }, (err) => console.error("Categories Error", err));

            // ä»»åŠ¡ç›‘å¬
            onSnapshot(collection(db, userPath, 'tasks'), (snap) => {
                tasks = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardStats();
                renderCategories();
            }, (err) => console.error("Tasks Error", err));
        };

        // --- æ•°æ®æ“ä½œ ---
        window.createCategory = async () => {
            if (!user) return;
            const name = document.getElementById('newCatName').value.trim();
            if (!name) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), {
                name, createdAt: new Date().toISOString()
            });
            document.getElementById('newCatName').value = '';
            window.closeModal('catModal');
            showToast("åˆ†ç±»å·²æ·»åŠ ");
        };

        window.createTask = async () => {
            if (!user || !activeCatId) return;
            const title = document.getElementById('newTaskTitle').value.trim();
            const priority = document.getElementById('newTaskPriority').value;
            if (!title) return;

            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'), {
                title, priority, catId: activeCatId, status: 'pending', createdAt: new Date().toISOString()
            });
            document.getElementById('newTaskTitle').value = '';
            window.closeModal('taskModal');
            showToast("ä»»åŠ¡å·²åŠ å…¥æ¸…å•");
        };

        window.toggleTask = async (taskId, currentStatus) => {
            if (!user) return;
            const newStatus = currentStatus === 'done' ? 'pending' : 'done';
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', taskId), {
                status: newStatus,
                completedAt: newStatus === 'done' ? new Date().toISOString() : null
            });
        };

        window.deleteTask = async (taskId) => {
            if (!user || !confirm("ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', taskId));
        };

        window.saveNote = async () => {
            if (!user) return;
            const content = document.getElementById('noteInput').value.trim();
            if (!content) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'notes'), {
                content, createdAt: new Date().toISOString()
            });
            document.getElementById('noteInput').value = '';
            showToast("çµæ„Ÿå·²å­˜å…¥äº‘ç«¯");
        };

        // --- æ¸²æŸ“å‡½æ•° ---
        const renderCategories = () => {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            categories.forEach(cat => {
                const catTasks = tasks.filter(t => t.catId === cat.id);
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <h3 style="color:#2d3748;">${cat.name}</h3>
                        <button onclick="window.openAddTask('${cat.id}')" style="background:var(--primary); color:white; border:none; border-radius:6px; padding:4px 10px; cursor:pointer; font-size:12px;">+ ä»»åŠ¡</button>
                    </div>
                    <div class="task-list">
                        ${catTasks.length === 0 ? '<div style="color:#ccc; font-size:12px; text-align:center; padding:10px;">æš‚æ— ä»»åŠ¡</div>' : ''}
                        ${catTasks.map(t => `
                            <div class="task-item ${t.priority} ${t.status === 'done' ? 'done' : ''}" style="${t.status === 'done' ? 'opacity:0.6; text-decoration:line-through;' : ''}">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span onclick="window.toggleTask('${t.id}', '${t.status}')" style="cursor:pointer; flex:1;">${t.title}</span>
                                    <button onclick="window.deleteTask('${t.id}')" style="background:none; border:none; color:#ffb3b3; cursor:pointer; font-size:18px;">&times;</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                grid.appendChild(card);
            });
        };

        const updateDashboardStats = () => {
            const urgent = tasks.filter(t => t.priority === 'p-urgent-important' && t.status !== 'done').length;
            const doneToday = tasks.filter(t => {
                if (!t.completedAt) return false;
                const today = new Date().toISOString().split('T')[0];
                return t.completedAt.startsWith(today);
            }).length;
            document.getElementById('urgentCount').innerText = urgent;
            document.getElementById('doneCount').innerText = doneToday;
        };

        window.switchTab = async (tabId, btn) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-tasks').classList.add('hidden');
            document.getElementById('tab-review').classList.add('hidden');
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            if (tabId === 'review') renderReview();
        };

        const renderReview = () => {
            if (!user) return;
            const list = document.getElementById('historyList');
            list.innerHTML = 'æ­£åœ¨åŠ è½½å†å²...';

            onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'notes'), (snap) => {
                const notes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                notes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                list.innerHTML = notes.length ? notes.map(n => `
                    <div class="card" style="padding:15px; border-left:4px solid var(--info); margin-bottom:15px;">
                        <div style="font-size:12px; color:#999;">${new Date(n.createdAt).toLocaleString()}</div>
                        <div style="margin-top:5px;">${n.content}</div>
                    </div>
                `).join('') : '<div style="text-align:center; color:#999; padding:20px;">è¿˜æ²¡æœ‰éšç¬”è®°å½•å“¦ã€‚</div>';
            }, (err) => {
                console.error("Review loading error:", err);
                list.innerHTML = 'åŠ è½½å†å²è®°å½•å¤±è´¥ã€‚';
            });
        };

        // --- äº‹ä»¶ç»‘å®š ---
        document.getElementById('loginBtn').onclick = handleAuth;
        document.getElementById('confirmCatBtn').onclick = window.createCategory;
        document.getElementById('confirmTaskBtn').onclick = window.createTask;
        document.getElementById('saveNoteBtn').onclick = window.saveNote;
        document.getElementById('logoutBtn').onclick = () => location.reload();

        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.openAddTask = (catId) => { activeCatId = catId; window.openModal('taskModal'); };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        };

        initAuth();
    </script>
</body>
</html>